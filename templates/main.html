<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>YNAB report</title>
    <style>

        @font-face {
          font-family: 'Lato';
          font-style: normal;
          font-weight: 400;
          src: local('Lato'), url(https://fonts.gstatic.com/s/lato/v14/S6uyw4BMUTPHjx4wXiWtFCc.woff2) format('woff2');
        }

        body{
            font-family: 'Lato';
            font-size: 14px;
            color: black;
            background-color: #559fb3;
        }

        table{
            background-color: #ebf6f9;
            border-right: #e4e7ea solid 1px;
            border-top: #e4e7ea solid 1px;
        }

        td{
            text-align: right;
            padding: 4px;
            border-left: #e4e7ea solid 1px;
            border-bottom: #e4e7ea solid 1px;
        }

        td.right{
            border-left: none;
            border-right: #c7cccf solid 1px;
        }

        td.min_amount{
           border-bottom: solid #00f600 1px;
        }

        td.max_amount{
           border-bottom: solid #ff7c8a 1px;
        }

        .high{
           color: #ff7c8a;
        }

        .low{
           color: #09DA28;
        }

        .header{
            font-weight: bold;
            color: white;
            background-color: #163a47;
        }

        .col_header{
           text-align: left;
        }

        .amount{
{#            float: right;#}
{#            width: 70%;#}
        }

        .color_warning{
            color: crimson;
        }

        .color_positive{
            color: #1cac76;
        }
    </style>
</head>
<body>

    <a href="/upload">Upload</a> {{ '%0.2f' % month_progress }}
    <table border="0" cellspacing="0" cellpadding="0">

    {# Iterate over categories #}
    {% for row in report_weeks %}


        <tr>
        {% set row_num=loop.index %}

        {# Calculate overspending in each category #}
        {% set overspend_days = 0 %}
        {% if row_num > 1 %}
            {# Category average #}
            {% set actual_month_spending = row[-3] | abs %}

            {% set average_spending = (row[-1] * 1)  | abs %}

            {#  +1 to avoid dev-by-zero #}
            {%  set actual_month_spending_ratio = actual_month_spending/(average_spending+1) %}

            {# Calculate overspent in days #}
            {% if actual_month_spending_ratio > month_progress and actual_month_spending < average_spending %}
                {% set overspend = actual_month_spending_ratio - month_progress %}
                {% set overspend_days = '%sd' % ((overspend * 30) + 1) | int %}
            {% else %}
                {%  set overspend_days = '' %}
            {% endif %}
        {% endif %}


        {# For each month in category #}
        {# ----------------------------------------#}
        {% for cell in row %}
            {% set col_num = loop.index %}

            {# Set header styles #}
            {% if row_num == 1 %}
                {% set _class="header" %}
            {% elif col_num == 1 or col_num == loop.length - 1 %}
                {% set _class="col_header" %}
            {% endif %}

            {# Set progress for current month #}
            {% if row_num > 2 and col_num == loop.length - 2 %}
                {% if overspend_days %}
                    {% set display_progress_bar %}
                        <span style="color: darkorange;">{{overspend_days}}</span>
                    {% endset %}
                {% elif actual_month_spending > average_spending%}
                    {% set amount_highlight="color_warning" %}
                {% else %}
                    {% set amount_highlight="color_positive" %}
                {% endif %}
            {% endif %}

            {# Set average value for last column #}
            {% if col_num == loop.length %}
                {% if average_spending %}
                    {% set val2 = average_spending %}
                {% else %}
                    {% set val2 = 999999999 %}
                {% endif %}
            {% else %}
                    {% set val2 = cell %}
            {% endif %}

            {% set prev_cell = loop.previtem %}

            {% if cell is number %}
                <td class="{{ _class }}">
                    <div style="display: flex; justify-content: space-between;">
                        {{ display_progress_bar }}
                        <span class="amount  {{ amount_highlight }}">
                            {{ '{0:,}'.format(val2 | int | abs) }}
                        </span>
                    </div>
                </td>
            {% else %}
                <td class="{{ _class }}"><div class="">{{ cell }}</div>
                </td>
            {% endif %}

        {% endfor %}
        </tr>
    {% endfor %}
    </table>
</body>
</html>
