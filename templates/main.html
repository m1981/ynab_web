<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>YNAB report</title>
    <style>

        @font-face {
          font-family: 'Lato';
          font-style: normal;
          font-weight: 400;
          src: local('Lato'), url(https://fonts.gstatic.com/s/lato/v14/S6uyw4BMUTPHjx4wXiWtFCc.woff2) format('woff2');
        }

        body{
            font-family: 'Lato';
            font-size: 14px;
            color: black;
            background-color: #559fb3;
        }

        table{
            background-color: #ebf6f9;
            border-right: #e4e7ea solid 1px;
            border-top: #e4e7ea solid 1px;
        }

        td{
            text-align: right;
            padding: 4px;
            border-left: #e4e7ea solid 1px;
            border-bottom: #e4e7ea solid 1px;
        }

        td.right{
            border-left: none;
            border-right: #c7cccf solid 1px;
        }

        .high{
           color: #ff7c8a;
        }

        .low{
           color: #09DA28;
        }

       .header{
            font-weight: bold;
            color: white;
            background-color: #163a47;
       }

       .col_header{
           text-align: left;
       }

        .amount{
            float: right;
        }

    </style>
</head>
<body>

    <a href="/upload">Upload</a>
    <table border="0" cellspacing="0" cellpadding="0">

    {# Categories in rows #}
    {% for row in report_weeks %}

        {% if '.' in row[0] %}
            {% set category_class ="category_group" %}
        {% endif %}

        {# Select spendings except last month (current) #}
        {% set amounts = row | select("number") | reject("equalto", 0) | reject("equalto", row[-1]) %}

        {# Looking for lower spending which is negative number that is why "max" is used #}
        {% set min_amount = amounts | max %}

        {# Looking for highest spending which is negative number that is why "min" is used #}
        {% set max_amount = row | select("number") | reject("equalto", 0) | reject("equalto", row[-1]) | min %}

        <tr class="{{ category_class }}">
        {% set row_num=loop.index %}
        {% set amount = 0 %}
        {% set cat_avg_spending = row[-1]%}

        {# Create progress bar #}
        {% if row_num > 1  %}
            {%  set month_spending_sofar = row[-3]/(row[-1]+1)%}
            {%  set month_progress = 14/31  %}
            {% if month_spending_sofar > month_progress %}
                {%  set overspend = month_spending_sofar - month_progress %}
                {% set overspend_days = ((overspend * 31) + 1) | int %}
            {% else %}
                {%  set overspend = 0 %}
            {% endif %}

            {%  set progress_bar %}
            <table style="padding: 0; border:0; width:100%; height:7px;" cellpadding="0" cellspacing="0">
                <tr>
{#                    <td style="padding: 0; border:0; width: {{ month_progress * 100 }}%; background-color: #09DA28"></td>#}
                    <td style="padding: 0; border:0;  background-color: darkorange; width:{{ overspend * 100 }}%; text-align: center; line-heigh: 4px; font-size: 6px;">
                        {{ overspend_days }}
                    </td>
                    <td style="padding: 0; border:0; width: 100%"></td>
                </tr>
            </table>
            {%  endset %}
        {% endif %}


        {#  For each month in category #}
        {% for cell in row %}
            {% set col_num = loop.index %}

            {# Set header styles #}
            {% if row_num == 1 %}
                {% set _class="header" %}
            {% elif col_num == 1 or col_num == loop.length - 1 %}
                {% set _class="col_header" %}
            {% endif %}

            {%  if col_num == loop.length - 2 %}
                {% set display_progress_bar = progress_bar %}
            {% else %}
            {%  set display_progress_bar = "" %}
            {% endif %}
                {% set sign = '' %}
                {# Do not indicate low/high for "Total" row>2 AND indicate only last month [-2] #}
                {% if row_num > 2 and cell is number and loop.index == loop.length - 2 %}
                    {% if cell | abs > (row[-1] * 1.2) | abs   and  (cell | abs - row[-1] | abs) | abs >= 50 %}
                        {% set high_low_class = "high" %}
                    {% else %}
{#                        {% set high_low_class = "low" %}#}
                    {% endif %}
                {%  endif %}

                {% set prev_cell = loop.previtem %}

                {% if cell is number %}
                    <td class="{{ _class }} {{ min_max_class }}">
                        <div class="amount {{ high_low_class }} {{ category_class }}">
                            {{ '{0:,}'.format(cell | int | abs) }}
                        </div><br>
                        {{ display_progress_bar }}
                    </td>
{#                    <td class="{{ high_low_class }} right">{{sign}}</td>#}
                {% else %}
                    <td class="{{ _class }}"><div class="">{{ cell }}</div>
                    </td>
                {% endif %}
            {% set amount = cell %}

        {% endfor %}
        </tr>
    {% endfor %}
    </table>
</body>
</html>
